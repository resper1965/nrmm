<!-- ðŸ›¡ï¸ FRONTEND AVANÃ‡ADO - MÃ“DULO DE VULNERABILIDADES m.RMM -->

<template>
  <!-- 1. DASHBOARD PRINCIPAL DE VULNERABILIDADES -->
  <div class="vulnerability-dashboard">
    <!-- Header com mÃ©tricas principais -->
    <div class="dashboard-header">
      <q-card class="metric-card critical">
        <q-card-section>
          <div class="metric-number">{{ dashboardData.critical_count || 0 }}</div>
          <div class="metric-label">Critical</div>
          <q-icon name="warning" class="metric-icon" />
        </q-card-section>
      </q-card>

      <q-card class="metric-card high">
        <q-card-section>
          <div class="metric-number">{{ dashboardData.high_count || 0 }}</div>
          <div class="metric-label">High</div>
          <q-icon name="error" class="metric-icon" />
        </q-card-section>
      </q-card>

      <q-card class="metric-card medium">
        <q-card-section>
          <div class="metric-number">{{ dashboardData.medium_count || 0 }}</div>
          <div class="metric-label">Medium</div>
          <q-icon name="priority_high" class="metric-icon" />
        </q-card-section>
      </q-card>

      <q-card class="metric-card low">
        <q-card-section>
          <div class="metric-number">{{ dashboardData.low_count || 0 }}</div>
          <div class="metric-label">Low</div>
          <q-icon name="info" class="metric-icon" />
        </q-card-section>
      </q-card>

      <q-card class="metric-card total">
        <q-card-section>
          <div class="metric-number">{{ dashboardData.total_vulnerabilities || 0 }}</div>
          <div class="metric-label">Total</div>
          <q-icon name="security" class="metric-icon" />
        </q-card-section>
      </q-card>
    </div>

    <!-- Filtros avanÃ§ados -->
    <q-card class="filters-section">
      <q-card-section>
        <div class="row q-gutter-md">
          <q-select
            v-model="filters.severity"
            :options="severityOptions"
            label="Severity"
            multiple
            chips
            style="min-width: 200px"
          />
          
          <q-select
            v-model="filters.status"
            :options="statusOptions"
            label="Status"
            multiple
            chips
            style="min-width: 200px"
          />
          
          <q-select
            v-model="filters.agent"
            :options="agentOptions"
            label="Agent"
            multiple
            chips
            use-input
            @filter="filterAgents"
            style="min-width: 200px"
          />
          
          <q-input
            v-model="filters.cve_search"
            label="CVE Search"
            debounce="500"
            clearable
          >
            <template v-slot:append>
              <q-icon name="search" />
            </template>
          </q-input>
          
          <q-btn 
            color="primary" 
            icon="search" 
            label="Apply Filters"
            @click="applyFilters"
          />
          
          <q-btn 
            color="secondary" 
            icon="clear" 
            label="Clear"
            @click="clearFilters"
          />
        </div>
      </q-card-section>
    </q-card>

    <!-- GrÃ¡ficos e TendÃªncias -->
    <div class="charts-section">
      <div class="row q-gutter-md">
        <!-- GrÃ¡fico de DistribuiÃ§Ã£o por Severidade -->
        <q-card class="col-md-5">
          <q-card-section>
            <div class="text-h6">Severity Distribution</div>
            <apexchart
              type="donut"
              :options="severityChartOptions"
              :series="severityChartSeries"
              height="300"
            />
          </q-card-section>
        </q-card>

        <!-- TendÃªncias nos Ãºltimos 30 dias -->
        <q-card class="col-md-6">
          <q-card-section>
            <div class="text-h6">Vulnerability Trends (30 days)</div>
            <apexchart
              type="area"
              :options="trendChartOptions"
              :series="trendChartSeries"
              height="300"
            />
          </q-card-section>
        </q-card>
      </div>

      <!-- Top CVEs e Agentes mais vulnerÃ¡veis -->
      <div class="row q-gutter-md q-mt-md">
        <q-card class="col-md-5">
          <q-card-section>
            <div class="text-h6">Top 10 CVEs</div>
            <q-list>
              <q-item
                v-for="cve in dashboardData.top_cves"
                :key="cve.cve_id"
                clickable
                @click="filterByCVE(cve.cve_id)"
              >
                <q-item-section>
                  <q-item-label>{{ cve.cve_id }}</q-item-label>
                  <q-item-label caption>{{ cve.count }} instances</q-item-label>
                </q-item-section>
                <q-item-section side>
                  <q-chip :color="getCVSSColor(cve.cvss_score)" text-color="white">
                    {{ cve.cvss_score || 'N/A' }}
                  </q-chip>
                </q-item-section>
              </q-item>
            </q-list>
          </q-card-section>
        </q-card>

        <q-card class="col-md-6">
          <q-card-section>
            <div class="text-h6">Most Vulnerable Agents</div>
            <q-list>
              <q-item
                v-for="agent in dashboardData.most_vulnerable_agents"
                :key="agent.agent__id"
                clickable
                @click="filterByAgent(agent.agent__id)"
              >
                <q-item-section>
                  <q-item-label>{{ agent.agent__hostname }}</q-item-label>
                  <q-item-label caption>
                    {{ agent.critical_count }} Critical, {{ agent.high_count }} High
                  </q-item-label>
                </q-item-section>
                <q-item-section side>
                  <q-badge 
                    :color="agent.critical_count > 0 ? 'red' : 'orange'" 
                    :label="agent.vuln_count"
                  />
                </q-item-section>
              </q-item>
            </q-list>
          </q-card-section>
        </q-card>
      </div>
    </div>

    <!-- Tabela de Vulnerabilidades -->
    <q-card class="vulnerabilities-table">
      <q-card-section>
        <div class="table-header">
          <div class="text-h6">Vulnerabilities</div>
          <div class="table-actions">
            <q-btn
              color="primary"
              icon="add"
              label="Start Scan"
              @click="showScanDialog = true"
            />
            <q-btn
              color="secondary"
              icon="file_download"
              label="Export"
              @click="exportVulnerabilities"
            />
            <q-btn
              v-if="selected.length > 0"
              color="orange"
              icon="edit"
              :label="`Bulk Update (${selected.length})`"
              @click="showBulkUpdateDialog = true"
            />
          </div>
        </div>

        <q-table
          :rows="vulnerabilities"
          :columns="vulnerabilityColumns"
          :loading="loading"
          :pagination="pagination"
          :selected.sync="selected"
          selection="multiple"
          row-key="id"
          @request="onRequest"
          binary-state-sort
          class="vulnerability-table"
        >
          <!-- Slot para CVE ID -->
          <template v-slot:body-cell-cve_id="props">
            <q-td :props="props">
              <q-chip
                v-if="props.value"
                :label="props.value"
                clickable
                @click="openCVEDetails(props.value)"
                color="primary"
                text-color="white"
              />
              <span v-else class="text-grey">N/A</span>
            </q-td>
          </template>

          <!-- Slot para Severidade -->
          <template v-slot:body-cell-severity="props">
            <q-td :props="props">
              <q-badge
                :color="getSeverityColor(props.value)"
                :label="props.value.toUpperCase()"
              />
            </q-td>
          </template>

          <!-- Slot para CVSS Score -->
          <template v-slot:body-cell-cvss_score="props">
            <q-td :props="props">
              <q-chip
                v-if="props.value"
                :color="getCVSSColor(props.value)"
                :label="props.value.toFixed(1)"
                text-color="white"
              />
              <span v-else class="text-grey">N/A</span>
            </q-td>
          </template>

          <!-- Slot para Status -->
          <template v-slot:body-cell-status="props">
            <q-td :props="props">
              <q-select
                v-model="props.row.status"
                :options="statusOptions"
                dense
                borderless
                @input="updateVulnerabilityStatus(props.row)"
                :color="getStatusColor(props.value)"
              />
            </q-td>
          </template>

          <!-- Slot para Age -->
          <template v-slot:body-cell-age_days="props">
            <q-td :props="props">
              <span :class="getAgeClass(props.value)">
                {{ props.value }} days
              </span>
            </q-td>
          </template>

          <!-- Slot para Actions -->
          <template v-slot:body-cell-actions="props">
            <q-td :props="props">
              <q-btn
                size="sm"
                color="primary"
                round
                dense
                icon="visibility"
                @click="viewVulnerabilityDetails(props.row)"
              >
                <q-tooltip>View Details</q-tooltip>
              </q-btn>
              <q-btn
                size="sm"
                color="orange"
                round
                dense
                icon="edit"
                @click="editVulnerability(props.row)"
                class="q-ml-xs"
              >
                <q-tooltip>Edit</q-tooltip>
              </q-btn>
              <q-btn
                size="sm"
                color="negative"
                round
                dense
                icon="delete"
                @click="deleteVulnerability(props.row)"
                class="q-ml-xs"
              >
                <q-tooltip>Delete</q-tooltip>
              </q-btn>
            </q-td>
          </template>
        </q-table>
      </q-card-section>
    </q-card>

    <!-- Dialog para iniciar scan -->
    <q-dialog v-model="showScanDialog" persistent>
      <StartScanDialog
        @scan-started="onScanStarted"
        @close="showScanDialog = false"
      />
    </q-dialog>

    <!-- Dialog para bulk update -->
    <q-dialog v-model="showBulkUpdateDialog" persistent>
      <BulkUpdateDialog
        :selected-vulnerabilities="selected"
        @updated="onBulkUpdate"
        @close="showBulkUpdateDialog = false"
      />
    </q-dialog>

    <!-- Dialog para detalhes da vulnerabilidade -->
    <q-dialog v-model="showDetailsDialog" maximized>
      <VulnerabilityDetailsDialog
        :vulnerability="selectedVulnerability"
        @close="showDetailsDialog = false"
        @updated="onVulnerabilityUpdated"
      />
    </q-dialog>
  </div>
</template>

<script>
import { ref, reactive, onMounted, computed } from 'vue'
import { api } from '@/api'
import VulnerabilityDetailsDialog from './VulnerabilityDetailsDialog.vue'
import StartScanDialog from './StartScanDialog.vue'
import BulkUpdateDialog from './BulkUpdateDialog.vue'

export default {
  name: 'VulnerabilityDashboard',
  components: {
    VulnerabilityDetailsDialog,
    StartScanDialog,
    BulkUpdateDialog
  },
  setup() {
    // Reactive data
    const loading = ref(false)
    const vulnerabilities = ref([])
    const dashboardData = ref({})
    const selected = ref([])
    const showScanDialog = ref(false)
    const showBulkUpdateDialog = ref(false)
    const showDetailsDialog = ref(false)
    const selectedVulnerability = ref(null)

    // Filters
    const filters = reactive({
      severity: [],
      status: [],
      agent: [],
      cve_search: ''
    })

    // Pagination
    const pagination = ref({
      sortBy: 'cvss_score',
      descending: true,
      page: 1,
      rowsPerPage: 25,
      rowsNumber: 0
    })

    // Options
    const severityOptions = [
      { label: 'Critical', value: 'critical' },
      { label: 'High', value: 'high' },
      { label: 'Medium', value: 'medium' },
      { label: 'Low', value: 'low' },
      { label: 'Info', value: 'info' }
    ]

    const statusOptions = [
      { label: 'Open', value: 'open' },
      { label: 'Fixed', value: 'fixed' },
      { label: 'Accepted Risk', value: 'accepted_risk' },
      { label: 'False Positive', value: 'false_positive' },
      { label: 'Under Review', value: 'under_review' },
      { label: 'Won\'t Fix', value: 'wont_fix' }
    ]

    const agentOptions = ref([])

    // Table columns
    const vulnerabilityColumns = [
      {
        name: 'cve_id',
        label: 'CVE ID',
        field: 'cve_id',
        sortable: true,
        align: 'left'
      },
      {
        name: 'title',
        label: 'Title',
        field: 'title',
        sortable: true,
        align: 'left',
        style: 'max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;'
      },
      {
        name: 'severity',
        label: 'Severity',
        field: 'severity',
        sortable: true,
        align: 'center'
      },
      {
        name: 'cvss_score',
        label: 'CVSS',
        field: 'cvss_score',
        sortable: true,
        align: 'center'
      },
      {
        name: 'status',
        label: 'Status',
        field: 'status',
        sortable: true,
        align: 'center'
      },
      {
        name: 'agent_hostname',
        label: 'Agent',
        field: 'agent_hostname',
        sortable: true,
        align: 'left'
      },
      {
        name: 'age_days',
        label: 'Age',
        field: 'age_days',
        sortable: true,
        align: 'center'
      },
      {
        name: 'first_seen',
        label: 'First Seen',
        field: 'first_seen',
        sortable: true,
        align: 'center',
        format: (val) => new Date(val).toLocaleDateString()
      },
      {
        name: 'actions',
        label: 'Actions',
        field: 'actions',
        align: 'center'
      }
    ]

    // Chart options
    const severityChartOptions = computed(() => ({
      chart: {
        type: 'donut'
      },
      labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
      colors: ['#ff4757', '#ff6b35', '#ffa502', '#2ed573', '#70a1ff'],
      legend: {
        position: 'bottom'
      },
      responsive: [{
        breakpoint: 480,
        options: {
          chart: {
            width: 200
          },
          legend: {
            position: 'bottom'
          }
        }
      }]
    }))

    const severityChartSeries = computed(() => [
      dashboardData.value.critical_count || 0,
      dashboardData.value.high_count || 0,
      dashboardData.value.medium_count || 0,
      dashboardData.value.low_count || 0,
      dashboardData.value.info_count || 0
    ])

    const trendChartOptions = computed(() => ({
      chart: {
        type: 'area',
        height: 300,
        zoom: {
          enabled: false
        }
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        curve: 'smooth'
      },
      xaxis: {
        type: 'datetime',
        categories: dashboardData.value.trend_data?.map(d => d.date) || []
      },
      tooltip: {
        x: {
          format: 'dd/MM/yy'
        }
      },
      colors: ['#ff4757']
    }))

    const trendChartSeries = computed(() => [{
      name: 'Vulnerabilities',
      data: dashboardData.value.trend_data?.map(d => d.count) || []
    }])

    // Methods
    const loadDashboardData = async () => {
      try {
        loading.value = true
        const response = await api.get('/vulnerability/vulnerabilities/dashboard/')
        dashboardData.value = response.data
      } catch (error) {
        console.error('Error loading dashboard data:', error)
      } finally {
        loading.value = false
      }
    }

    const loadVulnerabilities = async (props = {}) => {
      try {
        loading.value = true
        const { page = 1, rowsPerPage = 25, sortBy, descending } = props.pagination || pagination.value

        const params = {
          page,
          page_size: rowsPerPage,
          ordering: descending ? `-${sortBy}` : sortBy,
          ...buildFilterParams()
        }

        const response = await api.get('/vulnerability/vulnerabilities/', { params })
        
        vulnerabilities.value = response.data.results
        pagination.value.rowsNumber = response.data.count
        pagination.value.page = page
        pagination.value.rowsPerPage = rowsPerPage
        pagination.value.sortBy = sortBy
        pagination.value.descending = descending
      } catch (error) {
        console.error('Error loading vulnerabilities:', error)
      } finally {
        loading.value = false
      }
    }

    const buildFilterParams = () => {
      const params = {}
      
      if (filters.severity.length > 0) {
        params.severity = filters.severity.join(',')
      }
      
      if (filters.status.length > 0) {
        params.status = filters.status.join(',')
      }
      
      if (filters.agent.length > 0) {
        params.agent = filters.agent.map(a => a.value).join(',')
      }
      
      if (filters.cve_search) {
        params.cve_id__icontains = filters.cve_search
      }
      
      return params
    }

    const onRequest = (props) => {
      loadVulnerabilities(props)
    }

    const applyFilters = () => {
      pagination.value.page = 1
      loadVulnerabilities()
    }

    const clearFilters = () => {
      Object.keys(filters).forEach(key => {
        if (Array.isArray(filters[key])) {
          filters[key] = []
        } else {
          filters[key] = ''
        }
      })
      applyFilters()
    }

    const getSeverityColor = (severity) => {
      const colors = {
        critical: 'red',
        high: 'deep-orange',
        medium: 'orange',
        low: 'green',
        info: 'blue'
      }
      return colors[severity] || 'grey'
    }

    const getCVSSColor = (score) => {
      if (score >= 9.0) return 'red'
      if (score >= 7.0) return 'deep-orange'
      if (score >= 4.0) return 'orange'
      if (score >= 0.1) return 'green'
      return 'grey'
    }

    const getStatusColor = (status) => {
      const colors = {
        open: 'red',
        fixed: 'green',
        accepted_risk: 'orange',
        false_positive: 'blue',
        under_review: 'purple',
        wont_fix: 'grey'
      }
      return colors[status] || 'grey'
    }

    const getAgeClass = (days) => {
      if (days > 90) return 'text-red'
      if (days > 30) return 'text-orange'
      if (days > 7) return 'text-yellow'
      return 'text-green'
    }

    const updateVulnerabilityStatus = async (vulnerability) => {
      try {
        await api.post(`/vulnerability/vulnerabilities/${vulnerability.id}/update_status/`, {
          status: vulnerability.status,
          notes: 'Status updated from dashboard'
        })
        
        // Refresh data
        loadVulnerabilities()
        loadDashboardData()
      } catch (error) {
        console.error('Error updating vulnerability status:', error)
      }
    }

    const viewVulnerabilityDetails = (vulnerability) => {
      selectedVulnerability.value = vulnerability
      showDetailsDialog.value = true
    }

    const editVulnerability = (vulnerability) => {
      // Implementation for edit
      console.log('Edit vulnerability:', vulnerability)
    }

    const deleteVulnerability = (vulnerability) => {
      // Implementation for delete
      console.log('Delete vulnerability:', vulnerability)
    }

    const filterByCVE = (cveId) => {
      filters.cve_search = cveId
      applyFilters()
    }

    const filterByAgent = (agentId) => {
      const agent = agentOptions.value.find(a => a.value === agentId)
      if (agent) {
        filters.agent = [agent]
        applyFilters()
      }
    }

    const openCVEDetails = (cveId) => {
      // Open external CVE database
      window.open(`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${cveId}`, '_blank')
    }

    const exportVulnerabilities = async () => {
      try {
        const params = buildFilterParams()
        const response = await api.get('/vulnerability/vulnerabilities/export/', { 
          params,
          responseType: 'blob'
        })
        
        // Create download link
        const url = window.URL.createObjectURL(new Blob([response.data]))
        const link = document.createElement('a')
        link.href = url
        link.setAttribute('download', `vulnerabilities-${new Date().toISOString().split('T')[0]}.csv`)
        document.body.appendChild(link)
        link.click()
        link.remove()
        window.URL.revokeObjectURL(url)
      } catch (error) {
        console.error('Error exporting vulnerabilities:', error)
      }
    }

    const onScanStarted = () => {
      showScanDialog.value = false
      // Optionally show notification
    }

    const onBulkUpdate = () => {
      showBulkUpdateDialog.value = false
      selected.value = []
      loadVulnerabilities()
      loadDashboardData()
    }

    const onVulnerabilityUpdated = () => {
      showDetailsDialog.value = false
      loadVulnerabilities()
      loadDashboardData()
    }

    const filterAgents = (val, update) => {
      if (val === '') {
        update(() => {
          agentOptions.value = []
        })
        return
      }

      update(async () => {
        try {
          const response = await api.get('/agents/', {
            params: { search: val, page_size: 20 }
          })
          agentOptions.value = response.data.results.map(agent => ({
            label: agent.hostname,
            value: agent.id
          }))
        } catch (error) {
          console.error('Error loading agents:', error)
        }
      })
    }

    // Lifecycle
    onMounted(() => {
      loadDashboardData()
      loadVulnerabilities()
    })

    return {
      // Data
      loading,
      vulnerabilities,
      dashboardData,
      selected,
      showScanDialog,
      showBulkUpdateDialog,
      showDetailsDialog,
      selectedVulnerability,
      filters,
      pagination,
      
      // Options
      severityOptions,
      statusOptions,
      agentOptions,
      vulnerabilityColumns,
      
      // Chart data
      severityChartOptions,
      severityChartSeries,
      trendChartOptions,
      trendChartSeries,
      
      // Methods
      onRequest,
      applyFilters,
      clearFilters,
      getSeverityColor,
      getCVSSColor,
      getStatusColor,
      getAgeClass,
      updateVulnerabilityStatus,
      viewVulnerabilityDetails,
      editVulnerability,
      deleteVulnerability,
      filterByCVE,
      filterByAgent,
      openCVEDetails,
      exportVulnerabilities,
      onScanStarted,
      onBulkUpdate,
      onVulnerabilityUpdated,
      filterAgents
    }
  }
}
</script>

<style scoped>
.vulnerability-dashboard {
  padding: 20px;
}

.dashboard-header {
  display: flex;
  gap: 16px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.metric-card {
  min-width: 180px;
  position: relative;
  overflow: hidden;
}

.metric-card.critical {
  border-left: 4px solid #ff4757;
}

.metric-card.high {
  border-left: 4px solid #ff6b35;
}

.metric-card.medium {
  border-left: 4px solid #ffa502;
}

.metric-card.low {
  border-left: 4px solid #2ed573;
}

.metric-card.total {
  border-left: 4px solid #70a1ff;
}

.metric-number {
  font-size: 32px;
  font-weight: bold;
  line-height: 1;
}

.metric-label {
  font-size: 14px;
  color: #666;
  margin-top: 4px;
}

.metric-icon {
  position: absolute;
  top: 16px;
  right: 16px;
  font-size: 24px;
  opacity: 0.3;
}

.filters-section {
  margin-bottom: 24px;
}

.charts-section {
  margin-bottom: 24px;
}

.vulnerabilities-table {
  margin-bottom: 24px;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.table-actions {
  display: flex;
  gap: 8px;
}

.vulnerability-table {
  width: 100%;
}

.text-red {
  color: #ff4757;
}

.text-orange {
  color: #ffa502;
}

.text-yellow {
  color: #ffb142;
}

.text-green {
  color: #2ed573;
}
</style>


<!-- 2. COMPONENTE DE DETALHES DA VULNERABILIDADE -->
<template>
  <q-card class="vulnerability-details-card">
    <q-card-section class="bg-primary text-white">
      <div class="text-h6">
        {{ vulnerability?.title || 'Vulnerability Details' }}
      </div>
      <div class="text-subtitle2" v-if="vulnerability?.cve_id">
        {{ vulnerability.cve_id }}
      </div>
    </q-card-section>

    <q-card-section>
      <div class="row q-gutter-lg">
        <!-- Coluna da esquerda - InformaÃ§Ãµes bÃ¡sicas -->
        <div class="col-md-6">
          <div class="detail-section">
            <h6>Basic Information</h6>
            
            <q-field label="CVE ID" stack-label>
              <template v-slot:control>
                <div class="field-value">
                  <q-chip
                    v-if="vulnerability?.cve_id"
                    :label="vulnerability.cve_id"
                    color="primary"
                    text-color="white"
                    clickable
                    @click="openCVELink"
                  />
                  <span v-else class="text-grey">Not Available</span>
                </div>
              </template>
            </q-field>

            <q-field label="Severity" stack-label>
              <template v-slot:control>
                <q-badge
                  :color="getSeverityColor(vulnerability?.severity)"
                  :label="vulnerability?.severity?.toUpperCase()"
                />
              </template>
            </q-field>

            <q-field label="CVSS Score" stack-label>
              <template v-slot:control>
                <div class="field-value">
                  <q-chip
                    v-if="vulnerability?.cvss_score"
                    :color="getCVSSColor(vulnerability.cvss_score)"
                    :label="`${vulnerability.cvss_score} / 10.0`"
                    text-color="white"
                  />
                  <span v-else class="text-grey">Not Available</span>
                </div>
              </template>
            </q-field>

            <q-field label="Status" stack-label>
              <template v-slot:control>
                <q-select
                  v-model="localStatus"
                  :options="statusOptions"
                  dense
                  outlined
                  @input="updateStatus"
                />
              </template>
            </q-field>

            <q-field label="Agent" stack-label>
              <template v-slot:control>
                <div class="field-value">{{ vulnerability?.agent_hostname }}</div>
              </template>
            </q-field>

            <q-field label="First Seen" stack-label>
              <template v-slot:control>
                <div class="field-value">
                  {{ formatDate(vulnerability?.first_seen) }}
                  <q-chip
                    :label="`${vulnerability?.age_days} days ago`"
                    :color="getAgeColor(vulnerability?.age_days)"
                    size="sm"
                    class="q-ml-sm"
                  />
                </div>
              </template>
            </q-field>
          </div>

          <!-- LocalizaÃ§Ã£o -->
          <div class="detail-section">
            <h6>Location</h6>
            
            <q-field label="Host" stack-label>
              <template v-slot:control>
                <div class="field-value">{{ vulnerability?.host || 'N/A' }}</div>
              </template>
            </q-field>

            <q-field label="Port" stack-label>
              <template v-slot:control>
                <div class="field-value">{{ vulnerability?.port || 'N/A' }}</div>
              </template>
            </q-field>

            <q-field label="Service" stack-label>
              <template v-slot:control>
                <div class="field-value">{{ vulnerability?.service || 'N/A' }}</div>
              </template>
            </q-field>

            <q-field label="Protocol" stack-label>
              <template v-slot:control>
                <div class="field-value">{{ vulnerability?.protocol?.toUpperCase() || 'N/A' }}</div>
              </template>
            </q-field>
          </div>
        </div>

        <!-- Coluna da direita - DescriÃ§Ã£o e SoluÃ§Ãµes -->
        <div class="col-md-5">
          <div class="detail-section">
            <h6>Description</h6>
            <div class="description-box">
              {{ vulnerability?.description || 'No description available' }}
            </div>
          </div>

          <div class="detail-section">
            <h6>Solution</h6>
            <div class="solution-box">
              {{ vulnerability?.solution || 'No solution available' }}
            </div>
          </div>

          <div class="detail-section" v-if="vulnerability?.references?.length">
            <h6>References</h6>
            <q-list>
              <q-item
                v-for="(ref, index) in vulnerability.references"
                :key="index"
                clickable
                @click="openReference(ref)"
              >
                <q-item-section>
                  <q-item-label>{{ ref }}</q-item-label>
                </q-item-section>
                <q-item-section side>
                  <q-icon name="open_in_new" />
                </q-item-section>
              </q-item>
            </q-list>
          </div>

          <!-- Tags -->
          <div class="detail-section" v-if="vulnerability?.tags?.length">
            <h6>Tags</h6>
            <div class="tags-container">
              <q-chip
                v-for="tag in vulnerability.tags"
                :key="tag"
                :label="tag"
                color="secondary"
                size="sm"
                class="q-ma-xs"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Evidence Section -->
      <div class="detail-section" v-if="vulnerability?.evidence">
        <h6>Evidence</h6>
        <q-card class="evidence-card">
          <q-card-section>
            <pre class="evidence-text">{{ vulnerability.evidence }}</pre>
          </q-card-section>
        </q-card>
      </div>

      <!-- Status History -->
      <div class="detail-section">
        <h6>Status History</h6>
        <q-timeline color="secondary">
          <q-timeline-entry
            v-for="change in statusHistory"
            :key="change.id"
            :title="`Changed to ${change.new_status}`"
            :subtitle="formatDate(change.changed_at)"
            :caption="change.notes"
            icon="update"
          />
        </q-timeline>
      </div>
    </q-card-section>

    <!-- Actions -->
    <q-card-actions align="right">
      <q-btn flat label="Close" @click="$emit('close')" />
      <q-btn 
        color="primary" 
        label="Edit" 
        @click="editVulnerability" 
      />
      <q-btn 
        color="negative" 
        label="Mark as Fixed" 
        @click="markAsFixed"
        v-if="vulnerability?.status === 'open'"
      />
    </q-card-actions>
  </q-card>
</template>

<script>
// Script para VulnerabilityDetailsDialog component
import { ref, computed, watch } from 'vue'
import { api } from '@/api'

export default {
  name: 'VulnerabilityDetailsDialog',
  props: {
    vulnerability: {
      type: Object,
      default: () => ({})
    }
  },
  emits: ['close', 'updated'],
  setup(props, { emit }) {
    const localStatus = ref('')
    const statusHistory = ref([])

    const statusOptions = [
      { label: 'Open', value: 'open' },
      { label: 'Fixed', value: 'fixed' },
      { label: 'Accepted Risk', value: 'accepted_risk' },
      { label: 'False Positive', value: 'false_positive' },
      { label: 'Under Review', value: 'under_review' },
      { label: 'Won\'t Fix', value: 'wont_fix' }
    ]

    watch(() => props.vulnerability?.status, (newStatus) => {
      localStatus.value = newStatus || 'open'
    }, { immediate: true })

    const getSeverityColor = (severity) => {
      const colors = {
        critical: 'red',
        high: 'deep-orange',
        medium: 'orange',
        low: 'green',
        info: 'blue'
      }
      return colors[severity] || 'grey'
    }

    const getCVSSColor = (score) => {
      if (score >= 9.0) return 'red'
      if (score >= 7.0) return 'deep-orange'
      if (score >= 4.0) return 'orange'
      if (score >= 0.1) return 'green'
      return 'grey'
    }

    const getAgeColor = (days) => {
      if (days > 90) return 'red'
      if (days > 30) return 'orange'
      if (days > 7) return 'amber'
      return 'green'
    }

    const formatDate = (dateString) => {
      if (!dateString) return 'N/A'
      return new Date(dateString).toLocaleString()
    }

    const updateStatus = async () => {
      try {
        await api.post(`/vulnerability/vulnerabilities/${props.vulnerability.id}/update_status/`, {
          status: localStatus.value,
          notes: 'Status updated from details dialog'
        })
        emit('updated')
      } catch (error) {
        console.error('Error updating status:', error)
      }
    }

    const markAsFixed = async () => {
      localStatus.value = 'fixed'
      await updateStatus()
    }

    const openCVELink = () => {
      if (props.vulnerability?.cve_id) {
        window.open(`https://cve.mitre.org/cgi-bin/cvename.cgi?name=${props.vulnerability.cve_id}`, '_blank')
      }
    }

    const openReference = (ref) => {
      window.open(ref, '_blank')
    }

    const editVulnerability = () => {
      // Implementation for edit functionality
      console.log('Edit vulnerability')
    }

    return {
      localStatus,
      statusHistory,
      statusOptions,
      getSeverityColor,
      getCVSSColor,
      getAgeColor,
      formatDate,
      updateStatus,
      markAsFixed,
      openCVELink,
      openReference,
      editVulnerability
    }
  }
}
</script>

<style scoped>
.vulnerability-details-card {
  max-width: 1200px;
  width: 100%;
}

.detail-section {
  margin-bottom: 24px;
}

.detail-section h6 {
  margin: 0 0 16px 0;
  color: #1976d2;
  border-bottom: 1px solid #e0e0e0;
  padding-bottom: 8px;
}

.field-value {
  padding: 8px 0;
  font-weight: 500;
}

.description-box, .solution-box {
  background: #f5f5f5;
  padding: 16px;
  border-radius: 4px;
  min-height: 100px;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.evidence-card {
  background: #f8f9fa;
}

.evidence-text {
  font-family: 'Courier New', monospace;
  font-size: 12px;
  max-height: 300px;
  overflow-y: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.tags-container {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
}
</style>


<!-- IMPLEMENTAÃ‡ÃƒO JAVASCRIPT ADICIONAL -->
<script>
/**
 * API Service para Vulnerabilidades
 */
export const vulnerabilityApi = {
  // Dashboard
  getDashboard: () => api.get('/vulnerability/vulnerabilities/dashboard/'),
  
  // Vulnerabilities CRUD
  getVulnerabilities: (params) => api.get('/vulnerability/vulnerabilities/', { params }),
  getVulnerability: (id) => api.get(`/vulnerability/vulnerabilities/${id}/`),
  updateVulnerabilityStatus: (id, data) => api.post(`/vulnerability/vulnerabilities/${id}/update_status/`, data),
  bulkUpdateVulnerabilities: (data) => api.post('/vulnerability/vulnerabilities/bulk_update/', data),
  exportVulnerabilities: (params) => api.get('/vulnerability/vulnerabilities/export/', { params, responseType: 'blob' }),
  
  // Scanners
  getScanners: () => api.get('/vulnerability/scanners/'),
  getScanner: (id) => api.get(`/vulnerability/scanners/${id}/`),
  testConnection: (id) => api.post(`/vulnerability/scanners/${id}/test_connection/`),
  startScan: (id, data) => api.post(`/vulnerability/scanners/${id}/start_scan/`, data),
  getScannerStatistics: () => api.get('/vulnerability/scanners/statistics/'),
  
  // Scans
  getScans: (params) => api.get('/vulnerability/scans/', { params }),
  getScan: (id) => api.get(`/vulnerability/scans/${id}/`),
  
  // Reports
  generateReport: (data) => api.post('/vulnerability/reports/', data),
  getReports: () => api.get('/vulnerability/reports/'),
  downloadReport: (id) => api.get(`/vulnerability/reports/${id}/download/`, { responseType: 'blob' })
}

/**
 * Utility Functions
 */
export const vulnerabilityUtils = {
  getSeverityWeight: (severity) => {
    const weights = {
      'critical': 5,
      'high': 4,
      'medium': 3,
      'low': 2,
      'info': 1
    }
    return weights[severity] || 0
  },

  calculateRiskScore: (vulnerabilities) => {
    if (!vulnerabilities.length) return 0
    
    const totalWeight = vulnerabilities.reduce((sum, vuln) => {
      return sum + vulnerabilityUtils.getSeverityWeight(vuln.severity)
    }, 0)
    
    return Math.min(100, (totalWeight / vulnerabilities.length) * 20)
  },

  formatCVSS: (score) => {
    if (!score) return 'N/A'
    return `${score.toFixed(1)} / 10.0`
  },

  getDaysUntilDue: (dueDate) => {
    if (!dueDate) return null
    const now = new Date()
    const due = new Date(dueDate)
    const diff = Math.ceil((due - now) / (1000 * 60 * 60 * 24))
    return diff
  },

  isOverdue: (dueDate) => {
    const days = vulnerabilityUtils.getDaysUntilDue(dueDate)
    return days !== null && days < 0
  },

  getSLAStatus: (vulnerability) => {
    if (!vulnerability.due_date) return 'no_sla'
    
    const daysUntilDue = vulnerabilityUtils.getDaysUntilDue(vulnerability.due_date)
    
    if (daysUntilDue < 0) return 'overdue'
    if (daysUntilDue <= 1) return 'urgent'
    if (daysUntilDue <= 7) return 'warning'
    return 'ok'
  },

  exportToCSV: (vulnerabilities, filename = 'vulnerabilities.csv') => {
    const headers = [
      'CVE ID', 'Title', 'Severity', 'CVSS Score', 'Status', 
      'Agent', 'Host', 'Port', 'First Seen', 'Age (days)'
    ]
    
    const csvContent = [
      headers.join(','),
      ...vulnerabilities.map(vuln => [
        vuln.cve_id || '',
        `"${vuln.title || ''}"`,
        vuln.severity || '',
        vuln.cvss_score || '',
        vuln.status || '',
        vuln.agent_hostname || '',
        vuln.host || '',
        vuln.port || '',
        vuln.first_seen || '',
        vuln.age_days || ''
      ].join(','))
    ].join('\n')
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    const url = URL.createObjectURL(blob)
    link.setAttribute('href', url)
    link.setAttribute('download', filename)
    link.style.visibility = 'hidden'
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
  }
}

/**
 * Composables
 */
export const useVulnerabilities = () => {
  const vulnerabilities = ref([])
  const loading = ref(false)
  const error = ref(null)

  const loadVulnerabilities = async (params = {}) => {
    try {
      loading.value = true
      error.value = null
      const response = await vulnerabilityApi.getVulnerabilities(params)
      vulnerabilities.value = response.data.results || response.data
      return response.data
    } catch (err) {
      error.value = err.message
      console.error('Error loading vulnerabilities:', err)
      throw err
    } finally {
      loading.value = false
    }
  }

  const updateVulnerability = async (id, data) => {
    try {
      const response = await vulnerabilityApi.updateVulnerabilityStatus(id, data)
      
      // Update local state
      const index = vulnerabilities.value.findIndex(v => v.id === id)
      if (index !== -1) {
        vulnerabilities.value[index] = { ...vulnerabilities.value[index], ...response.data }
      }
      
      return response.data
    } catch (err) {
      error.value = err.message
      throw err
    }
  }

  return {
    vulnerabilities,
    loading,
    error,
    loadVulnerabilities,
    updateVulnerability
  }
}

export const useScanners = () => {
  const scanners = ref([])
  const loading = ref(false)

  const loadScanners = async () => {
    try {
      loading.value = true
      const response = await vulnerabilityApi.getScanners()
      scanners.value = response.data.results || response.data
    } catch (error) {
      console.error('Error loading scanners:', error)
    } finally {
      loading.value = false
    }
  }

  const testConnection = async (scannerId) => {
    try {
      const response = await vulnerabilityApi.testConnection(scannerId)
      return response.data
    } catch (error) {
      console.error('Error testing connection:', error)
      throw error
    }
  }

  return {
    scanners,
    loading,
    loadScanners,
    testConnection
  }
}
</script>